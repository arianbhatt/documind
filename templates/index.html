{% extends "base.html" %}

{% block content %}
<div class="main-layout">
    <!-- === UPDATED SIDEBAR HTML STRUCTURE === -->
    <aside id="sidebar" class="sidebar" data-collapsed="false">
        <div class="sidebar-header">
            <div class="logo-section">
                <!-- === LOGO SVG REPLACED WITH IMG TAG === -->
                <img src="{{ url_for('static', filename='logo.png') }}" alt="DocuMind Logo" class="logo-icon">
                <span class="logo-text">DocuMind</span>
            </div>
            <!-- === COLLAPSE BUTTON REMOVED === -->
        </div>
        
        <div class="sidebar-actions">
            <button id="new-chat-btn" class="btn btn-primary btn-block">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                <span>New Chat</span>
            </button>
        </div>

        <div class="sidebar-section-header">
            <h3 class="section-title">Recent Chats</h3>
        </div>
        
        <div class="sidebar-search">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input 
                type="text" 
                id="chat-search" 
                placeholder="Search chats..." 
                class="search-input"
            >
        </div>
        
        <div class="chat-list" id="chat-list">
            <!-- Chat items will be dynamically loaded here by sidebar.js -->
        </div>
        
        <div class="sidebar-footer">
            <select id="model-selector" class="model-selector">
                <option>Google (Gemini 2.5 Flash)</option>
                <!-- <option>Google (Gemini Pro)</option> <-- REMOVED -->
                <option>Local (Gemma 2 2B)</option>
            </select>
            <button class="sidebar-footer-btn" id="theme-toggle" title="Toggle theme">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
                <span>Theme</span>
            </button>
            <button class="sidebar-footer-btn" id="settings-btn" title="Settings">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Settings</span>
            </button>
        </div>
    </aside>
    
    <!-- === Main Chat Area === -->
    <main class="chat-area" id="chat-area">
        <header class="chat-header">
            <button id="sidebar-toggle-mobile" class="icon-btn mobile-only">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            
            <div class="chat-info">
                <h2 class="chat-title" id="current-chat-title">New Chat</h2>
                <!-- MODIFIED: Removed style="display: none;" -->
                <button class="icon-btn" id="rename-chat-btn" title="Rename chat">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                    </svg>
                </button>
                <span class="chat-subtitle" id="document-count">No documents uploaded</span>
            </div>
            
            <div class="chat-actions">
                <button class="icon-btn" id="upload-btn" title="Upload documents">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </button>
                <button class="icon-btn" id="download-chat-btn" title="Download Chat History">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                         <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                         <polyline points="7 10 12 15 17 10"/>
                         <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </header>
        
        <div class="messages-container" id="messages-container">
            <div class="empty-state" id="empty-state">
                <svg class="empty-state-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <h3>Start a conversation</h3>
                <p>Upload documents and ask questions to get started</p>
                <button class="btn btn-primary" id="upload-docs-btn-main">
                    Upload Documents
                </button>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <button class="icon-btn attach-btn" id="attach-btn" title="Upload Documents">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                
                <textarea 
                    id="message-input" 
                    class="message-input" 
                    placeholder="Ask anything about your documents..."
                    rows="1"
                ></textarea>
                
                <button class="icon-btn send-btn" id="send-btn" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
            
            <div class="input-footer">
                <span class="input-hint">Press Enter to send, Shift+Enter for new line</span>
                <span class="model-info" id="model-info-display">Google (Gemini 2.5 Flash)</span>
            </div>
        </div>
    </main>
    
    <!-- === Settings Panel === -->
    <aside id="right-panel" class="right-panel hidden">
        <div class="panel-header">
            <h3>Settings</h3>
            <button class="icon-btn" id="close-settings-panel" title="Close settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="panel-content" id="panel-content">
            <div class="settings-group">
                <label for="custom-api-key-input">Custom Google API Key</label>
                <p class="settings-hint">
                    Use this to override the server's .env file. Key is saved in your browser.
                </p>
                <input type="password" id="custom-api-key-input" class="settings-input" placeholder="Enter your Google API Key...">
            </div>
            <button class="btn btn-primary btn-block" id="save-settings-btn">Save Key</button>
        </div>
    </aside>
</div>

<!-- === Upload Modal === -->
<div id="upload-modal" class="modal hidden">
    <div class="modal-overlay" data-close-modal></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Documents</h3>
            <button class="icon-btn close-modal" id="close-upload-modal" data-close-modal>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="upload-area" id="upload-area">
                <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>Drag and drop files here or click to browse</p>
                <span class="upload-hint">Supports PDF files only</span>
                <input type="file" id="file-input" multiple accept=".pdf" hidden>
            </div>
            
            <div class="file-list-container" id="modal-file-list-container">
                <!-- File items will be injected here by document-upload.js -->
            </div>
            
            <div class="upload-progress hidden" id="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span class="progress-text" id="progress-text">Uploading...</span>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-upload" data-close-modal>Cancel</button>
            <button class="btn btn-primary" id="confirm-upload-btn" disabled>Upload</button>
        </div>
    </div>
</div>

<!-- === NEW: Rename Chat Modal === -->
<div id="rename-modal" class="modal hidden">
    <div class="modal-overlay" data-close-modal></div>
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Rename Chat</h3>
            <button class="icon-btn close-modal" data-close-modal>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-text">Enter a new name for this chat session.</p>
            <input type="text" id="rename-input" class="settings-input" placeholder="Enter new chat name...">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-rename-btn" data-close-modal>Cancel</button>
            <button class="btn btn-primary" id="confirm-rename-btn">Save</button>
        </div>
    </div>
</div>

<!-- === NEW: Confirm Delete Modal === -->
<div id="confirm-delete-modal" class="modal hidden">
    <div class="modal-overlay" data-close-modal></div>
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Delete Chat?</h3>
            <button class="icon-btn close-modal" data-close-modal>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-text" id="delete-modal-text">
                Are you sure you want to delete this chat? This action cannot be undone.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-delete-btn" data-close-modal>Cancel</button>
            <button class="btn btn-danger" id="confirm-delete-btn">Yes, Delete</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='js/document-upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}